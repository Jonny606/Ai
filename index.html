<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Chatbot</title>
    <!-- Load Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load React and ReactDOM from CDNs -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Load Babel for JSX support -->
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Load Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // This script block makes the Firebase functions globally available to the main app script
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            onAuthStateChanged,
            signInWithCustomToken,
            getFirestore,
            collection,
            addDoc,
            onSnapshot,
            query,
            serverTimestamp
        };
    </script>
    <!-- Google Fonts for "Inter" -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Tailwind gray-900 */
        }
    </style>
</head>
<body class="bg-gray-900">
    <!-- The root element where the React app will be rendered -->
    <div id="root"></div>

    <!-- Your React App code goes here -->
    <script type="text/babel">
        // The following code is your React component from the Canvas.
        import { useState, useRef, useEffect } from 'react';

        // Firebase configuration from the environment
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Initialize Firebase app using the globally available functions
        const app = window.firebase.initializeApp(firebaseConfig);
        const auth = window.firebase.getAuth(app);
        const db = window.firebase.getFirestore(app);

        const CHAT_COLLECTION = `artifacts/${appId}/public/data/chats`;

        // SVG for the paper plane icon
        const PaperPlaneIcon = () => (
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-5 h-5">
            <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
          </svg>
        );

        // SVG for the spinner icon
        const SpinnerIcon = () => (
          <svg className="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        );

        // SVG for the copy icon
        const CopyIcon = () => (
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-4 h-4">
            <path strokeLinecap="round" strokeLinejoin="round" d="M15.75 17.25v-4.062a2.25 2.25 0 012.25-2.25h.375c.621 0 1.125-.504 1.125-1.125V6.75a9.75 9.75 0 00-7.854-9.75 7.5 7.5 0 00-7.5 7.5c0 4.148 3.393 7.542 7.5 7.5zm.375 0a.75.75 0 01-.75.75h-.375c-.621 0-1.125-.504-1.125-1.125V6.75a9.75 9.75 0 00-7.854-9.75 7.5 7.5 0 00-7.5 7.5c0 4.148 3.393 7.542 7.5 7.5z" />
          </svg>
        );

        // Component for a copyable code block
        const ClipboardCopyButton = ({ textToCopy }) => {
          const [isCopied, setIsCopied] = useState(false);

          const handleCopy = () => {
            try {
              const el = document.createElement('textarea');
              el.value = textToCopy;
              document.body.appendChild(el);
              el.select();
              document.execCommand('copy');
              document.body.removeChild(el);
              setIsCopied(true);
              setTimeout(() => setIsCopied(false), 2000); // Reset after 2 seconds
            } catch (err) {
              console.error('Failed to copy text: ', err);
            }
          };

          return (
            <button
              onClick={handleCopy}
              className="absolute top-2 right-2 p-1 rounded-md text-white bg-gray-800 hover:bg-gray-700 transition-colors duration-200"
            >
              {isCopied ? "Copied!" : <CopyIcon />}
            </button>
          );
        };

        // The main Chatbot component
        export default function App() {
          const [messages, setMessages] = useState([]);
          const [input, setInput] = useState('');
          const [isSending, setIsSending] = useState(false);
          const [userId, setUserId] = useState(null);
          const messagesEndRef = useRef(null);

          // Auto-scroll to the bottom of the chat window
          const scrollToBottom = () => {
            messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
          };

          // Sign in anonymously and set up the chat listener
          useEffect(() => {
            const signIn = async () => {
              try {
                if (initialAuthToken) {
                  await window.firebase.signInWithCustomToken(auth, initialAuthToken);
                } else {
                  await window.firebase.signInAnonymously(auth);
                }
              } catch (error) {
                console.error("Error signing in:", error);
              }
            };
            signIn();

            const unsubscribe = window.firebase.onAuthStateChanged(auth, (user) => {
              if (user) {
                setUserId(user.uid);
                console.log(`User ID: ${user.uid}`);
                
                // Listen for new messages in Firestore
                // Note: orderBy() is removed to avoid index errors. Data will be sorted in-memory.
                const q = window.firebase.query(window.firebase.collection(db, CHAT_COLLECTION));
                const unsubscribeSnapshot = window.firebase.onSnapshot(q, (snapshot) => {
                  const newMessages = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                  })).sort((a, b) => a.timestamp.seconds - b.timestamp.seconds); // Sort by timestamp
                  setMessages(newMessages);
                });

                return () => unsubscribeSnapshot();
              } else {
                setUserId(null);
              }
            });

            return () => unsubscribe();
          }, []);

          useEffect(() => {
            scrollToBottom();
          }, [messages]);

          const handleSendMessage = async (e) => {
            e.preventDefault();
            if (!input.trim() || isSending) return;

            const userMessage = {
              text: input,
              sender: 'user',
              timestamp: window.firebase.serverTimestamp()
            };

            setIsSending(true);
            setInput('');

            try {
              // Add user message to Firestore
              await window.firebase.addDoc(window.firebase.collection(db, CHAT_COLLECTION), userMessage);

              // Call the Gemini API to get a response
              const responseText = await getGeminiResponse(input);
              
              const botMessage = {
                text: responseText,
                sender: 'gemini',
                timestamp: window.firebase.serverTimestamp()
              };
              
              // Add the bot's response to Firestore
              await window.firebase.addDoc(window.firebase.collection(db, CHAT_COLLECTION), botMessage);
            } catch (error) {
              console.error("Error sending message:", error);
              // Fallback message if something goes wrong
              await window.firebase.addDoc(window.firebase.collection(db, CHAT_COLLECTION), {
                text: "I'm sorry, I couldn't generate a response at this time.",
                sender: 'gemini',
                timestamp: window.firebase.serverTimestamp()
              });
            } finally {
              setIsSending(false);
            }
          };

          const getGeminiResponse = async (prompt) => {
            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            let response;
            for (let i = 0; i < 3; i++) { // Retry with exponential backoff
              try {
                response = await fetch(apiUrl, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(payload)
                });

                if (response.ok) break;
                if (response.status === 429) {
                  const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                  await new Promise(resolve => setTimeout(resolve, delay));
                } else {
                  throw new Error(`API error: ${response.statusText}`);
                }
              } catch (error) {
                console.error("Error fetching from Gemini API:", error);
                if (i === 2) throw error;
              }
            }

            const result = await response.json();
            if (result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
              return result.candidates[0].content.parts[0].text;
            } else {
              console.error("Unexpected API response structure:", result);
              return "I'm sorry, I encountered an issue while generating a response.";
            }
          };

          const renderMessageContent = (text) => {
            const parts = text.split(/(```[\s\S]*?```)/);
            return parts.map((part, index) => {
              if (part.startsWith('```') && part.endsWith('```')) {
                // This is a code block
                const codeContent = part.substring(3, part.length - 3).trim();
                return (
                  <div key={index} className="relative mt-2 text-sm md:text-base">
                    <pre className="bg-gray-900 text-teal-400 p-3 rounded-lg overflow-x-auto whitespace-pre-wrap break-words">
                      <code>{codeContent}</code>
                    </pre>
                    <ClipboardCopyButton textToCopy={codeContent} />
                  </div>
                );
              } else {
                // This is normal text
                return <p key={index} className="text-sm md:text-base break-words">{part}</p>;
              }
            });
          };

          return (
            <div className="flex flex-col h-screen w-full bg-gray-900 text-gray-100 font-sans antialiased">
              <div className="flex flex-col flex-1 overflow-hidden p-4">
                <h1 className="text-3xl font-bold text-center text-teal-400 mb-4">Gemini Chat</h1>
                <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-800 rounded-xl shadow-lg border border-gray-700">
                  {messages.map((msg, index) => (
                    <div
                      key={index}
                      className={`flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`}
                    >
                      <div
                        className={`max-w-xs md:max-w-md lg:max-w-lg p-3 rounded-xl shadow-md transition-transform duration-300 ease-in-out transform ${
                          msg.sender === 'user'
                            ? 'bg-teal-600 text-white rounded-br-none hover:scale-105'
                            : 'bg-gray-700 text-white rounded-bl-none hover:scale-105'
                        }`}
                      >
                        {renderMessageContent(msg.text)}
                      </div>
                    </div>
                  ))}
                  <div ref={messagesEndRef} />
                </div>
              </div>

              <form onSubmit={handleSendMessage} className="p-4 bg-gray-900 border-t border-gray-700 flex items-center">
                <input
                  type="text"
                  value={input}
                  onChange={(e) => setInput(e.target.value)}
                  className="flex-1 p-3 rounded-full bg-gray-800 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-teal-500 transition-all duration-300 mr-2"
                  placeholder="Type a message..."
                  disabled={isSending}
                />
                <button
                  type="submit"
                  className={`p-3 rounded-full text-white transition-all duration-300 ${
                    isSending
                      ? 'bg-gray-600 cursor-not-allowed'
                      : 'bg-teal-500 hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-teal-500 transform hover:scale-110'
                  }`}
                  disabled={isSending}
                >
                  {isSending ? <SpinnerIcon /> : <PaperPlaneIcon />}
                </button>
              </form>
            </div>
          );
        }

        // Render the App component into the root div
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(React.createElement(App, null));
    </script>
</body>
</html>
